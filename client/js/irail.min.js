var app=angular.module("iRail",["ngResource"]);app.config(["$routeProvider","$httpProvider",function(a,b){a.when("/",{templateUrl:"views/home.html",controller:DirectionsCtrl}).when("/route/:fromStation/:toStation/:dateString/:timeString/:timeSelection",{templateUrl:"views/route.html",controller:RouteCtrl}).when("/train/:trainId",{templateUrl:"views/train.html",controller:TrainCtrl}).when("/station/:stationName",{templateUrl:"views/station-liveboard.html",controller:StationDetailCtrl}).otherwise({redirectTo:"/"});delete b.defaults.headers.common["X-Requested-With"];b.responseInterceptors.push("httpInterceptor");var c=function(e,d){$("#spinner").show();return e};b.defaults.transformRequest.push(c)}]);app.factory("httpInterceptor",["$q",function(a){return function(b){return b.then(function(c){$("#spinner").hide();return c},function(c){$("#spinner").hide();return a.reject(c)})}}]);app.filter("replace",function(){return function(a,d,c){var e=new RegExp(d);var b=a.replace(e,c);return b}});app.run(["$rootScope",function(a){a.iRailAPI="http://api.irail.be";a.parseVehicleName=function(b){return b.split(".")[2]}}]);var DirectionsCtrl=["$scope","$location","utilityService",function(a,d,c){var b=new Date();a.day=b.getDate();a.month=b.getMonth()+1;a.year=b.getFullYear();a.hours=b.getHours();a.minutes=b.getMinutes();a.departure="depart";a.switchFromTo=function(){var e=a.from;a.from=a.to;a.to=e};a.searchDirections=function(){var h=c.addLeadingZeroIfNeeded(a.day);var f=c.addLeadingZeroIfNeeded(a.month);var i=a.year.toString().substr(2);var e=c.addLeadingZeroIfNeeded(a.hours);var g=c.addLeadingZeroIfNeeded(a.minutes);d.path("/route/"+a.from+"/"+a.to+"/"+h+f+i+"/"+e+g+"/"+a.departure)};a.searchStations=function(){d.path("/station/"+a.station)};a.directions=function(){$("#directions").addClass("active");$("#stations").removeClass("active");$("#myrail").removeClass("active")};a.stations=function(){$("#directions").removeClass("active");$("#stations").addClass("active");$("#myrail").removeClass("active")};a.myRail=function(){$("#directions").removeClass("active");$("#stations").removeClass("active");$("#myrail").addClass("active")}}];var RouteCtrl=["$scope","$routeParams","$http","$rootScope","$location","utilityService",function(k,j,g,i,c,b){k.toStation=j.toStation;k.fromStation=j.fromStation;var h=parseInt(j.dateString.substring(0,2));var d=parseInt(j.dateString.substring(2,4));var f=parseInt("20"+j.dateString.substring(4,6));k.routeDate=new Date(f,d-1,h);k.date=j.dateString;k.parseNbVias=function(l){if(l){return parseInt(l.number)}return 0};var a=i.iRailAPI+"/connections/?to="+j.toStation+"&from="+j.fromStation+"&date="+k.date+"&time="+j.timeString+"&timeSel="+j.timeSelection+"&format=json";g.get(a).success(function(l){k.possibleRoutes=e(l.connection)});k.open=function(n){var r=angular.element.find(".list-detail");for(var q=0;q<r.length;q++){var m=r[q];$(m).hide(500)}var s=angular.element.find(".list-head__collapse-btn");for(var q=0;q<s.length;q++){var l=s[q];$(l).removeClass("opened");$(l).addClass("closed")}var p=$(".list-detail",n.currentTarget);p.show(500);var o=$(".list-head__collapse-btn",n.currentTarget);o.removeClass("closed");o.addClass("opened")};k.earlier=function(){var m=b.getIrailDateString(k.routeDate);var n=new Date(k.possibleRoutes[0].arrival.time*1000);var l=b.getIrailTimeString(n);var o=(n.getHours()<10?"0":"")+n.getHours()+(n.getMinutes()<10?"0":"")+n.getMinutes();c.path("/route/"+k.fromStation+"/"+k.toStation+"/"+m+"/"+l+"/arrive")};k.later=function(){var o=new Date(k.possibleRoutes[k.possibleRoutes.length-1].departure.time*1000);var l=b.addLeadingZeroIfNeeded(o.getHours())+addLeadingZeroIfNeeded(o.getMinutes());var n=b.addLeadingZeroIfNeeded(o.getDate());var m=b.addLeadingZeroIfNeeded(o.getMonth()+1);var p=o.getFullYear().toString().substr(2);c.path("/route/"+k.fromStation+"/"+k.toStation+"/"+n+m+p+"/"+l+"/depart")};k.earliest=function(){var m=b.addLeadingZeroIfNeeded(k.routeDate.getDate());var l=b.addLeadingZeroIfNeeded(k.routeDate.getMonth()+1);var n=k.routeDate.getFullYear().toString().substr(2);c.path("/route/"+k.fromStation+"/"+k.toStation+"/"+m+l+n+"/0300/depart")};k.latest=function(){var o=new Date(k.routeDate);o.setDate(o.getDate()+1);var m=b.addLeadingZeroIfNeeded(o.getDate());var l=b.addLeadingZeroIfNeeded(o.getMonth()+1);var n=o.getFullYear().toString().substr(2);c.path("/route/"+k.fromStation+"/"+k.toStation+"/"+m+l+n+"/0300/arrive")};k.$on("ngRepeatFinished",function(l){b.pngFallback()});function e(r){for(var p=0;p<r.length;p++){var m=r[p];var l=m.arrival.direction;if(!m.vias){continue}for(var o=m.vias.via.length-1;o>=0;o--){var n=m.vias.via[o];var q=n.direction;n.direction=l;l=q}}return r}}];var StationDetailCtrl=["$scope","$rootScope","$routeParams","$http","utilityService",function StationDetailCtrl(b,a,d,e,c){b.stationName=d.stationName;url=a.iRailAPI+"/liveboard/?station="+b.stationName+"&fast=true&format=json";e.get(url).success(function(f){b.liveboard=f.departures});b.$on("ngRepeatFinished",function(){c.pngFallback()})}];var TrainCtrl=["$scope","$routeParams","$http","$rootScope","utilityService",function(b,e,f,a,d){b.trainNumber=e.trainId;var c=a.iRailAPI+"/vehicle/?id="+e.trainId+"&fast=true&format=json";f.get(c).success(function(g){b.stops=g.stops});b.$on("ngRepeatFinished",function(){d.pngFallback()})}];app.directive("autoComplete",["$timeout","stationService",function(c,b){var a=function(e,d){d.autocomplete({source:e,minLength:2,select:function(){c(function(){d.trigger("input")},0)}})};return function(d,e){b.getResource(function(f){a(f,e)})}}]);app.directive("onFinishRender",["$timeout",function(a){return{restrict:"A",link:function(d,c,b){if(d.$last===true){a(function(){d.$emit("ngRepeatFinished")})}}}}]);app.factory("stationService",["$resource","$cacheFactory","$rootScope",function(d,f,b){var c=f("stationService");var a=d(b.iRailAPI+"/stations/?lang=en&format=json");return{getResource:function(h){var g=c.get("stations");if(!g){a.get(function(i){g=e(i.station);c.put("stations",g);h(g)})}else{h(g)}}};function e(k){var j=[];for(var g=0;g<k.length;g++){var h=k[g];j.push(h.name)}return j}}]);app.factory("utilityService",function(){return{addLeadingZeroIfNeeded:function(a){if(a<10){return"0"+a.toString()}return a.toString()},pngFallback:function(){if(!Modernizr.svg){(function(){var d=document.getElementsByTagName("img"),c=/.*\.svg$/,b=0,a=d.length;for(;b<a;++b){if(d[b].src.match(c)){d[b].src=d[b].src.slice(0,-3)+"png"}}})()}},getIrailDateString:function(b){var c=this.addLeadingZeroIfNeeded(b.getDate());var a=this.addLeadingZeroIfNeeded(b.getMonth()+1);var d=b.getFullYear().toString().substr(2);return c+a+d},getIrailTimeString:function(b){var a=this.addLeadingZeroIfNeeded(b.getHours());var c=this.addLeadingZeroIfNeeded(b.getMinutes());return a+c}}});