var app=angular.module("iRail",["ngResource"]);app.config(["$routeProvider","$httpProvider",function(a,b){a.when("/",{templateUrl:"views/home.html",controller:DirectionsCtrl}).when("/route/:fromStation/:toStation/:dateString/:timeString/:timeSelection",{templateUrl:"views/route.html",controller:RouteCtrl}).when("/train/:trainId",{templateUrl:"views/train.html",controller:TrainCtrl}).when("/station/:stationName",{templateUrl:"views/station-liveboard.html",controller:StationDetailCtrl}).otherwise({redirectTo:"/"});delete b.defaults.headers.common["X-Requested-With"];b.responseInterceptors.push("httpInterceptor");var c=function(e,d){$("#spinner").show();return e};b.defaults.transformRequest.push(c)}]);app.factory("httpInterceptor",["$q",function(a){return function(b){return b.then(function(c){$("#spinner").hide();return c},function(c){$("#spinner").hide();return a.reject(c)})}}]);app.filter("replace",function(){return function(a,d,c){var e=new RegExp(d);var b=a.replace(e,c);return b}});app.run(["$rootScope",function(a){a.iRailAPI="http://api.irail.be";a.parseVehicleName=function(b){return b.split(".")[2]}}]);var DirectionsCtrl=["$scope","$location","utilityService",function(a,d,c){var b=new Date();a.day=b.getDate();a.month=b.getMonth()+1;a.year=b.getFullYear();a.hours=b.getHours();a.minutes=b.getMinutes();a.departure="depart";a.switchFromTo=function(){var e=a.from;a.from=a.to;a.to=e};a.searchDirections=function(){var h=c.addLeadingZeroIfNeeded(a.day);var f=c.addLeadingZeroIfNeeded(a.month);var i=a.year.toString().substr(2);var e=c.addLeadingZeroIfNeeded(a.hours);var g=c.addLeadingZeroIfNeeded(a.minutes);d.path("/route/"+a.from+"/"+a.to+"/"+h+f+i+"/"+e+g+"/"+a.departure)};a.searchStations=function(){d.path("/station/"+a.station)};a.focus=function(e,f){if(f){$("#"+e).focus()}};a.directions=function(){$("#directions").addClass("active");$("#stations").removeClass("active");$("#myrail").removeClass("active")};a.stations=function(){$("#directions").removeClass("active");$("#stations").addClass("active");$("#myrail").removeClass("active")};a.myRail=function(){$("#directions").removeClass("active");$("#stations").removeClass("active");$("#myrail").addClass("active")}}];var RouteCtrl=["$scope","$routeParams","$http","$rootScope","$location","utilityService",function(l,k,h,j,d,c){l.toStation=k.toStation;l.fromStation=k.fromStation;var i=parseInt(k.dateString.substring(0,2));var e=parseInt(k.dateString.substring(2,4));var g=parseInt("20"+k.dateString.substring(4,6));l.routeDate=new Date(g,e-1,i);l.date=k.dateString;l.parseNbVias=function(m){if(m){return parseInt(m.number)}return 0};var a=j.iRailAPI+"/connections/?to="+k.toStation+"&from="+k.fromStation+"&date="+l.date+"&time="+k.timeString+"&timeSel="+k.timeSelection+"&format=json";h.get(a).success(function(m){l.possibleRoutes=f(m.connection)});l.open=function(o){var s=angular.element.find(".list-detail");for(var r=0;r<s.length;r++){var n=s[r];$(n).hide(500)}var t=angular.element.find(".list-head__collapse-btn");for(var r=0;r<t.length;r++){var m=t[r];$(m).removeClass("opened");$(m).addClass("closed")}var q=$(".list-detail",o.currentTarget);q.show(500);var p=$(".list-head__collapse-btn",o.currentTarget);p.removeClass("closed");p.addClass("opened")};l.earlier=function(){var n=c.getIrailDateString(l.routeDate);var o=new Date(l.possibleRoutes[0].arrival.time*1000);var m=c.getIrailTimeString(o);b(n,m,"arrive")};l.later=function(){var o=new Date(l.possibleRoutes[l.possibleRoutes.length-1].departure.time*1000);var n=c.getIrailDateString(o);var m=c.getIrailTimeString(o);b(n,m,"depart")};l.earliest=function(){var m=c.getIrailDateString(l.routeDate);b(m,"0300","depart")};l.latest=function(){var n=new Date(l.routeDate);n.setDate(n.getDate()+1);var m=c.getIrailDateString(n);b(m,"0300","arrive")};l.$on("ngRepeatFinished",function(m){c.pngFallback()});function f(s){for(var q=0;q<s.length;q++){var n=s[q];var m=n.arrival.direction;if(!n.vias){continue}for(var p=n.vias.via.length-1;p>=0;p--){var o=n.vias.via[p];var r=o.direction;o.direction=m;m=r}}return s}function b(o,n,m){d.path("/route/"+l.fromStation+"/"+l.toStation+"/"+o+"/"+n+"/"+m)}}];var StationDetailCtrl=["$scope","$rootScope","$routeParams","$http","utilityService",function StationDetailCtrl(b,a,d,e,c){b.stationName=d.stationName;url=a.iRailAPI+"/liveboard/?station="+b.stationName+"&fast=true&format=json";e.get(url).success(function(f){b.liveboard=f.departures});b.$on("ngRepeatFinished",function(){c.pngFallback()})}];var TrainCtrl=["$scope","$routeParams","$http","$rootScope","utilityService",function(b,e,f,a,d){b.trainNumber=e.trainId;var c=a.iRailAPI+"/vehicle/?id="+e.trainId+"&fast=true&format=json";f.get(c).success(function(g){b.stops=g.stops});b.$on("ngRepeatFinished",function(){d.pngFallback()})}];app.directive("autoComplete",["$timeout","stationService",function(c,b){var a=function(f,e,d){e.autocomplete({source:f,minLength:2,select:function(){c(function(){e.trigger("input");e.change()},0);d.$apply()}})};return function(d,e){b.getResource(function(f){a(f,e,d)})}}]);app.directive("onFinishRender",["$timeout",function(a){return{restrict:"A",link:function(d,c,b){if(d.$last===true){a(function(){d.$emit("ngRepeatFinished")})}}}}]);app.directive("onEnter",function(){return function(c,b,a){b.bind("keydown keypress",function(d){if(d.which===13){b.trigger("input");c.$apply(function(){c.$eval(a.onEnter)})}})}});app.factory("stationService",["$resource","$cacheFactory","$rootScope",function(d,f,b){var c=f("stationService");var a=d(b.iRailAPI+"/stations/?lang=en&format=json");return{getResource:function(h){var g=c.get("stations");if(!g){a.get(function(i){g=e(i.station);c.put("stations",g);h(g)})}else{h(g)}}};function e(k){var j=[];for(var g=0;g<k.length;g++){var h=k[g];j.push(h.name)}return j}}]);app.factory("utilityService",function(){return{addLeadingZeroIfNeeded:function(a){if(a<10){return"0"+a.toString()}return a.toString()},pngFallback:function(){if(!Modernizr.svg){(function(){var d=document.getElementsByTagName("img"),c=/.*\.svg$/,b=0,a=d.length;for(;b<a;++b){if(d[b].src.match(c)){d[b].src=d[b].src.slice(0,-3)+"png"}}})()}},getIrailDateString:function(b){var c=this.addLeadingZeroIfNeeded(b.getDate());var a=this.addLeadingZeroIfNeeded(b.getMonth()+1);var d=b.getFullYear().toString().substr(2);return c+a+d},getIrailTimeString:function(b){var a=this.addLeadingZeroIfNeeded(b.getHours());var c=this.addLeadingZeroIfNeeded(b.getMinutes());return a+c}}});