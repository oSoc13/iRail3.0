var app=angular.module("iRail",["ngResource","LocalStorageModule"]);app.config(["$routeProvider","$httpProvider",function(a,b){a.when("/",{templateUrl:"views/home.html",controller:DirectionsCtrl}).when("/route/:fromStation/:toStation",{templateUrl:"views/route.html",controller:RouteCtrl}).when("/route/:fromStation/:toStation/:dateString/:timeString/:timeSelection",{templateUrl:"views/route.html",controller:RouteCtrl}).when("/train/:trainId",{templateUrl:"views/train.html",controller:TrainCtrl}).when("/station/:stationName",{templateUrl:"views/station-liveboard.html",controller:StationDetailCtrl}).otherwise({redirectTo:"/"});delete b.defaults.headers.common["X-Requested-With"];b.responseInterceptors.push("httpInterceptor");var c=function(e,d){$("#spinner").show();return e};b.defaults.transformRequest.push(c)}]);app.factory("httpInterceptor",["$q",function(a){return function(b){return b.then(function(c){$("#spinner").hide();return c},function(c){$("#spinner").hide();return a.reject(c)})}}]);app.filter("replace",function(){return function(a,d,c){var e=new RegExp(d);var b=a.replace(e,c);return b}});app.run(["$rootScope",function(a){a.iRailAPI="http://api.irail.be";a.parseVehicleName=function(b){return b.split(".")[2]}}]);var DirectionsCtrl=["$scope","$location","utilityService","favoriteRouteService",function(a,e,c,d){var b=new Date();a.day=b.getDate();a.month=b.getMonth()+1;a.year=b.getFullYear();a.hours=b.getHours();a.minutes=b.getMinutes();a.departure="depart";a.favoriteRoutes=d.getFavorites();a.switchFromTo=function(){var f=a.from;a.from=a.to;a.to=f};a.searchDirections=function(){var i=c.addLeadingZeroIfNeeded(a.day);var g=c.addLeadingZeroIfNeeded(a.month);var j=a.year.toString().substr(2);var f=c.addLeadingZeroIfNeeded(a.hours);var h=c.addLeadingZeroIfNeeded(a.minutes);e.path("/route/"+a.from+"/"+a.to+"/"+i+g+j+"/"+f+h+"/"+a.departure)};a.searchStations=function(){e.path("/station/"+a.station)};a.directions=function(){$("#directions").addClass("active");$("#stations").removeClass("active");$("#myrail").removeClass("active")};a.stations=function(){$("#directions").removeClass("active");$("#stations").addClass("active");$("#myrail").removeClass("active")};a.myRail=function(){$("#directions").removeClass("active");$("#stations").removeClass("active");$("#myrail").addClass("active")}}];var RouteCtrl=["$scope","$routeParams","$http","$rootScope","$location","utilityService","favoriteRouteService",function(m,k,h,j,d,c,l){m.toStation=k.toStation;m.fromStation=k.fromStation;if(k.dateString){var i=parseInt(k.dateString.substring(0,2));var e=parseInt(k.dateString.substring(2,4));var g=parseInt("20"+k.dateString.substring(4,6));m.routeDate=new Date(g,e-1,i);m.date=k.dateString;m.time=k.timeString}else{m.routeDate=new Date();m.date=c.getIrailDateString(m.routeDate);m.time=c.getIrailTimeString(m.routeDate)}m.parseNbVias=function(n){if(n){return parseInt(n.number)}return 0};var a=j.iRailAPI+"/connections/?to="+k.toStation+"&from="+k.fromStation+"&date="+m.date+"&time="+m.time+"&timeSel="+k.timeSelection+"&format=json";h.get(a).success(function(n){m.possibleRoutes=f(n.connection)});m.open=function(p){var t=angular.element.find(".list-detail");for(var s=0;s<t.length;s++){var o=t[s];$(o).hide(500)}var u=angular.element.find(".list-head__collapse-btn");for(var s=0;s<u.length;s++){var n=u[s];$(n).removeClass("opened");$(n).addClass("closed")}var r=$(".list-detail",p.currentTarget);r.show(500);var q=$(".list-head__collapse-btn",p.currentTarget);q.removeClass("closed");q.addClass("opened")};m.earlier=function(){var o=c.getIrailDateString(m.routeDate);var p=new Date(m.possibleRoutes[0].arrival.time*1000);var n=c.getIrailTimeString(p);b(o,n,"arrive")};m.later=function(){var p=new Date(m.possibleRoutes[m.possibleRoutes.length-1].departure.time*1000);var o=c.getIrailDateString(p);var n=c.getIrailTimeString(p);b(o,n,"depart")};m.earliest=function(){var n=c.getIrailDateString(m.routeDate);b(n,"0300","depart")};m.latest=function(){var o=new Date(m.routeDate);o.setDate(o.getDate()+1);var n=c.getIrailDateString(o);b(n,"0300","arrive")};m.$on("ngRepeatFinished",function(n){c.pngFallback()});m.favorite=function(){l.addFavorite(m.fromStation,m.toStation)};function f(t){for(var r=0;r<t.length;r++){var o=t[r];var n=o.arrival.direction;if(!o.vias){continue}for(var q=o.vias.via.length-1;q>=0;q--){var p=o.vias.via[q];var s=p.direction;p.direction=n;n=s}}return t}function b(p,o,n){d.path("/route/"+m.fromStation+"/"+m.toStation+"/"+p+"/"+o+"/"+n)}}];var StationDetailCtrl=["$scope","$rootScope","$routeParams","$http","utilityService",function StationDetailCtrl(b,a,d,e,c){b.stationName=d.stationName;url=a.iRailAPI+"/liveboard/?station="+b.stationName+"&fast=true&format=json";e.get(url).success(function(f){b.liveboard=f.departures});b.$on("ngRepeatFinished",function(){c.pngFallback()})}];var TrainCtrl=["$scope","$routeParams","$http","$rootScope","utilityService",function(b,e,f,a,d){b.trainNumber=e.trainId;var c=a.iRailAPI+"/vehicle/?id="+e.trainId+"&fast=true&format=json";f.get(c).success(function(g){b.stops=g.stops});b.$on("ngRepeatFinished",function(){d.pngFallback()})}];app.directive("autoComplete",["$timeout","stationService",function(c,b){var a=function(e,d){d.autocomplete({source:e,minLength:2,select:function(){c(function(){d.trigger("input")},0)}})};return function(d,e){b.getResource(function(f){a(f,e)})}}]);app.directive("onFinishRender",["$timeout",function(a){return{restrict:"A",link:function(d,c,b){if(d.$last===true){a(function(){d.$emit("ngRepeatFinished")})}}}}]);var angularLocalStorage=angular.module("LocalStorageModule",[]);angularLocalStorage.constant("prefix","iRailApp");angularLocalStorage.constant("cookie",{expiry:30,path:"/"});angularLocalStorage.service("localStorageService",["$rootScope","prefix","cookie",function($rootScope,prefix,cookie){if(prefix.substr(-1)!=="."){prefix=!!prefix?prefix+".":""}var browserSupportsLocalStorage=function(){try{return("localStorage" in window&&window.localStorage!==null)}catch(e){$rootScope.$broadcast("LocalStorageModule.notification.error",e.message);return false}};var addToLocalStorage=function(key,value){if(!browserSupportsLocalStorage()){$rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED");return addToCookies(key,value)}if(!value&&value!==0&&value!==""){return false}try{localStorage.setItem(prefix+key,value)}catch(e){$rootScope.$broadcast("LocalStorageModule.notification.error",e.message);return addToCookies(key,value)}return true};var getFromLocalStorage=function(key){if(!browserSupportsLocalStorage()){$rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED");return getFromCookies(key)}var item=localStorage.getItem(prefix+key);if(!item){return null}return item};var removeFromLocalStorage=function(key){if(!browserSupportsLocalStorage()){$rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED");return removeFromCookies(key)}try{localStorage.removeItem(prefix+key)}catch(e){$rootScope.$broadcast("LocalStorageModule.notification.error",e.message);return removeFromCookies(key)}return true};var clearAllFromLocalStorage=function(){if(!browserSupportsLocalStorage()){$rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED");return clearAllFromCookies()}var prefixLength=prefix.length;for(var key in localStorage){if(key.substr(0,prefixLength)===prefix){try{removeFromLocalStorage(key.substr(prefixLength))}catch(e){$rootScope.$broadcast("LocalStorageModule.notification.error",e.message);return clearAllFromCookies()}}}return true};var browserSupportsCookies=function(){try{return navigator.cookieEnabled||("cookie" in document&&(document.cookie.length>0||(document.cookie="test").indexOf.call(document.cookie,"test")>-1))}catch(e){$rootScope.$broadcast("LocalStorageModule.notification.error",e.message);return false}};var addToCookies=function(key,value){if(typeof value=="undefined"){return false}if(!browserSupportsCookies()){$rootScope.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED");return false}try{var expiry="",expiryDate=new Date();if(value===null){cookie.expiry=-1;value=""}if(cookie.expiry!==0){expiryDate.setTime(expiryDate.getTime()+(cookie.expiry*24*60*60*1000));expiry=", expires="+expiryDate.toGMTString()}if(!!key){document.cookie=prefix+key+"="+encodeURIComponent(value)+expiry+", path="+cookie.path}}catch(e){$rootScope.$broadcast("LocalStorageModule.notification.error",e.message);return false}return true};var getFromCookies=function(key){if(!browserSupportsCookies()){$rootScope.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED");return false}var cookies=document.cookie.split(",");for(var i=0;i<cookies.length;i++){var thisCookie=cookies[i];while(thisCookie.charAt(0)==" "){thisCookie=thisCookie.substring(1,thisCookie.length)}if(thisCookie.indexOf(prefix+key+"=")===0){return decodeURIComponent(thisCookie.substring(prefix.length+key.length+1,thisCookie.length))}}return null};var removeFromCookies=function(key){addToCookies(key,null)};var clearAllFromCookies=function(){var thisCookie=null,thisKey=null;var prefixLength=prefix.length;var cookies=document.cookie.split(";");for(var i=0;i<cookies.length;i++){thisCookie=cookies[i];while(thisCookie.charAt(0)==" "){thisCookie=thisCookie.substring(1,thisCookie.length)}key=thisCookie.substring(prefixLength,thisCookie.indexOf("="));removeFromCookies(key)}};var stringifyJson=function(vContent,isJSON){if(typeof vContent==="string"&&vContent.charAt(0)!=="{"&&!isJSON){return vContent}if(vContent instanceof Object){var sOutput="";if(vContent.constructor===Array){for(var nId=0;nId<vContent.length;sOutput+=this.stringifyJson(vContent[nId],true)+",",nId++){}return"["+sOutput.substr(0,sOutput.length-1)+"]"}if(vContent.toString!==Object.prototype.toString){return'"'+vContent.toString().replace(/"/g,"\\$&")+'"'}for(var sProp in vContent){sOutput+='"'+sProp.replace(/"/g,"\\$&")+'":'+this.stringifyJson(vContent[sProp],true)+","}return"{"+sOutput.substr(0,sOutput.length-1)+"}"}return typeof vContent==="string"?'"'+vContent.replace(/"/g,"\\$&")+'"':String(vContent)};var parseJson=function(sJSON){if(sJSON.charAt(0)!=="{"){return sJSON}return eval("("+sJSON+")")};return{isSupported:browserSupportsLocalStorage,add:addToLocalStorage,get:getFromLocalStorage,remove:removeFromLocalStorage,clearAll:clearAllFromLocalStorage,stringifyJson:stringifyJson,parseJson:parseJson,cookie:{add:addToCookies,get:getFromCookies,remove:removeFromCookies,clearAll:clearAllFromCookies}}}]);app.factory("stationService",["$resource","$cacheFactory","$rootScope",function(d,f,b){var c=f("stationService");var a=d(b.iRailAPI+"/stations/?lang=en&format=json");return{getResource:function(h){var g=c.get("stations");if(!g){a.get(function(i){g=e(i.station);c.put("stations",g);h(g)})}else{h(g)}}};function e(k){var j=[];for(var g=0;g<k.length;g++){var h=k[g];j.push(h.name)}return j}}]);app.factory("utilityService",function(){return{addLeadingZeroIfNeeded:function(a){if(a<10){return"0"+a.toString()}return a.toString()},pngFallback:function(){if(!Modernizr.svg){(function(){var d=document.getElementsByTagName("img"),c=/.*\.svg$/,b=0,a=d.length;for(;b<a;++b){if(d[b].src.match(c)){d[b].src=d[b].src.slice(0,-3)+"png"}}})()}},getIrailDateString:function(b){var c=this.addLeadingZeroIfNeeded(b.getDate());var a=this.addLeadingZeroIfNeeded(b.getMonth()+1);var d=b.getFullYear().toString().substr(2);return c+a+d},getIrailTimeString:function(b){var a=this.addLeadingZeroIfNeeded(b.getHours());var c=this.addLeadingZeroIfNeeded(b.getMinutes());return a+c}}});app.factory("favoriteRouteService",["localStorageService",function(a){return{addFavorite:function(f,e){var b=JSON.parse(a.get("favoriteRoutes"));if(!b){b=[]}for(var d=0;d<b.length;d++){var c=b[d];if(c.from==f&&c.to==e){return}}b.push({from:f,to:e});a.add("favoriteRoutes",JSON.stringify(b))},getFavorites:function(){return JSON.parse(a.get("favoriteRoutes"))}}}]);