var app=angular.module("iRail",["ngResource","LocalStorageModule"]);app.config(["$routeProvider","$httpProvider",function(a,b){a.when("/",{templateUrl:"views/home.html",controller:DirectionsCtrl}).when("/route/:fromStation/:toStation",{templateUrl:"views/route.html",controller:RouteCtrl}).when("/route/:fromStation/:toStation/:dateString/:timeString/:timeSelection",{templateUrl:"views/route.html",controller:RouteCtrl}).when("/route/:fromStation/:toStation/:dateString/:timeString/:timeSelection/:selectedRoute",{templateUrl:"views/route.html",controller:RouteCtrl}).when("/train/:trainId",{templateUrl:"views/train.html",controller:TrainCtrl}).when("/station/:stationName",{templateUrl:"views/station-liveboard.html",controller:StationDetailCtrl}).otherwise({redirectTo:"/"});delete b.defaults.headers.common["X-Requested-With"];b.responseInterceptors.push("httpInterceptor");var c=function(e,d){$("#spinner").show();return e};b.defaults.transformRequest.push(c)}]);app.factory("httpInterceptor",["$q",function(a){return function(b){return b.then(function(c){$("#spinner").hide();return c},function(c){$("#spinner").hide();return a.reject(c)})}}]);app.filter("replace",function(){return function(a,d,c){var e=new RegExp(d);var b=a.replace(e,c);return b}});app.run(["$rootScope",function(a){a.iRailAPI="http://api.irail.be";a.parseVehicleName=function(b){return b.split(".")[2]};a.back=function(){history.back()}}]);var DirectionsCtrl=["$scope","$location","utilityService","favoriteRouteService","$rootScope",function(b,f,d,e,a){var c=new Date();b.day=c.getDate();b.month=c.getMonth()+1;b.year=c.getFullYear();b.hours=c.getHours();b.minutes=c.getMinutes();b.departure="depart";b.favoriteRoutes=e.getFavorites();a.hasBackbutton=false;b.switchFromTo=function(){var g=b.from;b.from=b.to;b.to=g};b.searchDirections=function(){var j=d.addLeadingZeroIfNeeded(b.day);var h=d.addLeadingZeroIfNeeded(b.month);var k=b.year.toString().substr(2);var g=d.addLeadingZeroIfNeeded(b.hours);var i=d.addLeadingZeroIfNeeded(b.minutes);f.path("/route/"+b.from+"/"+b.to+"/"+j+h+k+"/"+g+i+"/"+b.departure)};b.searchStations=function(){f.path("/station/"+b.station)};b.focus=function(g,h){if(h){$("#"+g).focus()}};b.unFavorite=function(h,g){console.log("removing "+h+" - "+g);e.removeFavorite(h,g)};b.$on("favoritesChanged",function(){b.favoriteRoutes=e.getFavorites()});b.directions=function(){$("#directions").addClass("active");$("#stations").removeClass("active");$("#myrail").removeClass("active")};b.stations=function(){$("#directions").removeClass("active");$("#stations").addClass("active");$("#myrail").removeClass("active")};b.myRail=function(){$("#directions").removeClass("active");$("#stations").removeClass("active");$("#myrail").addClass("active")}}];var RouteCtrl=["$scope","$routeParams","$http","$rootScope","$location","utilityService","favoriteRouteService","historyService",function(n,l,j,k,e,d,m,c){n.toStation=l.toStation;n.fromStation=l.fromStation;k.hasBackbutton=true;if(l.dateString){var i=parseInt(l.dateString.substring(0,2));var f=parseInt(l.dateString.substring(2,4));var h=parseInt("20"+l.dateString.substring(4,6));n.routeDate=new Date(h,f-1,i);n.date=l.dateString;n.time=l.timeString;n.timesel=l.timeSelection}else{n.routeDate=new Date();n.date=d.getIrailDateString(n.routeDate);n.time=d.getIrailTimeString(n.routeDate);n.timesel="depart"}if(l.selectedRoute){n.lastRouteOpened=(l.selectedRoute=="last")}n.parseNbVias=function(p){if(p){return parseInt(p.number)}return 0};o();var a=k.iRailAPI+"/connections/?to="+l.toStation+"&from="+l.fromStation+"&date="+n.date+"&time="+n.time+"&timeSel="+n.timesel+"&format=json";j.get(a).success(function(p){n.possibleRoutes=g(p.connection)});n.open=function(r){var v=$(".list-head__collapse-btn",r.currentTarget);if(v.hasClass("opened")){return}var u=angular.element.find(".list-detail");for(var t=0;t<u.length;t++){var q=u[t];$(q).hide(500)}var w=angular.element.find(".list-head__collapse-btn");for(var t=0;t<w.length;t++){var p=w[t];$(p).removeClass("opened");$(p).addClass("closed")}var s=$(".list-detail",r.currentTarget);s.show(500);v.removeClass("closed");v.addClass("opened")};n.earlier=function(){var q=d.getIrailDateString(n.routeDate);var r=new Date(n.possibleRoutes[0].arrival.time*1000);var p=d.getIrailTimeString(r);n.lastRouteOpened=false;b(q,p,"arrive")};n.later=function(){var r=new Date(n.possibleRoutes[n.possibleRoutes.length-1].departure.time*1000);var q=d.getIrailDateString(r);var p=d.getIrailTimeString(r);n.lastRouteOpened=false;b(q,p,"depart")};n.earliest=function(){var p=d.getIrailDateString(n.routeDate);n.lastRouteOpened=false;b(p,"0300","depart")};n.latest=function(){var q=new Date(n.routeDate);q.setDate(q.getDate()+1);var p=d.getIrailDateString(q);n.lastRouteOpened=true;b(p,"0300","arrive")};n.$on("ngRepeatFinished",function(p){d.pngFallback()});n.favorite=function(){m.addFavorite(n.fromStation,n.toStation)};n.unfavorite=function(){m.removeFavorite(n.fromStation,n.toStation)};n.alreadyFavorited=function(){return m.exists(n.fromStation,n.toStation)};function g(v){for(var t=0;t<v.length;t++){var q=v[t];var p=q.arrival.direction;if(!q.vias){continue}for(var s=q.vias.via.length-1;s>=0;s--){var r=q.vias.via[s];var u=r.direction;r.direction=p;p=u}}return v}function b(s,r,p){var q="/route/"+n.fromStation+"/"+n.toStation+"/"+s+"/"+r+"/"+p;if(n.lastRouteOpened){q+="/last"}e.path(q)}function o(){var p=new Date();if(Modernizr.geolocation){navigator.geolocation.getCurrentPosition(function(q){var s=q.coords.latitude;var r=q.coords.longitude;c.add(p,n.fromStation,n.toStation,s,r)},function(q){},{enableHighAccuracy:false})}else{}}}];var StationDetailCtrl=["$scope","$rootScope","$routeParams","$http","utilityService",function StationDetailCtrl(b,a,d,e,c){b.stationName=d.stationName;a.hasBackbutton=true;url=a.iRailAPI+"/liveboard/?station="+b.stationName+"&fast=true&format=json";e.get(url).success(function(f){b.liveboard=f.departures});b.$on("ngRepeatFinished",function(){c.pngFallback()})}];var TrainCtrl=["$scope","$routeParams","$http","$rootScope","utilityService",function(b,e,f,a,d){b.trainNumber=e.trainId;a.hasBackbutton=true;var c=a.iRailAPI+"/vehicle/?id="+e.trainId+"&fast=true&format=json";f.get(c).success(function(g){b.stops=g.stops});b.$on("ngRepeatFinished",function(){d.pngFallback()})}];app.directive("autoComplete",["$timeout","stationService",function(c,b){var a=function(f,e,d){e.autocomplete({source:f,minLength:2,select:function(){c(function(){e.trigger("input");e.change()},0);d.$apply()}})};return function(d,e){b.getResource(function(f){a(f,e,d)})}}]);app.directive("onFinishRender",["$timeout",function(a){return{restrict:"A",link:function(d,c,b){if(d.$last===true){a(function(){d.$emit("ngRepeatFinished")})}}}}]);app.directive("onEnter",function(){return function(c,b,a){b.bind("keydown keypress",function(d){if(d.which===13){b.trigger("input");c.$apply(function(){c.$eval(a.onEnter)})}})}});var angularLocalStorage=angular.module("LocalStorageModule",[]);angularLocalStorage.constant("prefix","iRailApp");angularLocalStorage.constant("cookie",{expiry:30,path:"/"});angularLocalStorage.service("localStorageService",["$rootScope","prefix","cookie",function($rootScope,prefix,cookie){if(prefix.substr(-1)!=="."){prefix=!!prefix?prefix+".":""}var browserSupportsLocalStorage=function(){try{return("localStorage" in window&&window.localStorage!==null)}catch(e){$rootScope.$broadcast("LocalStorageModule.notification.error",e.message);return false}};var addToLocalStorage=function(key,value){if(!browserSupportsLocalStorage()){$rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED");return addToCookies(key,value)}if(!value&&value!==0&&value!==""){return false}try{localStorage.setItem(prefix+key,value)}catch(e){$rootScope.$broadcast("LocalStorageModule.notification.error",e.message);return addToCookies(key,value)}return true};var getFromLocalStorage=function(key){if(!browserSupportsLocalStorage()){$rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED");return getFromCookies(key)}var item=localStorage.getItem(prefix+key);if(!item){return null}return item};var removeFromLocalStorage=function(key){if(!browserSupportsLocalStorage()){$rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED");return removeFromCookies(key)}try{localStorage.removeItem(prefix+key)}catch(e){$rootScope.$broadcast("LocalStorageModule.notification.error",e.message);return removeFromCookies(key)}return true};var clearAllFromLocalStorage=function(){if(!browserSupportsLocalStorage()){$rootScope.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED");return clearAllFromCookies()}var prefixLength=prefix.length;for(var key in localStorage){if(key.substr(0,prefixLength)===prefix){try{removeFromLocalStorage(key.substr(prefixLength))}catch(e){$rootScope.$broadcast("LocalStorageModule.notification.error",e.message);return clearAllFromCookies()}}}return true};var browserSupportsCookies=function(){try{return navigator.cookieEnabled||("cookie" in document&&(document.cookie.length>0||(document.cookie="test").indexOf.call(document.cookie,"test")>-1))}catch(e){$rootScope.$broadcast("LocalStorageModule.notification.error",e.message);return false}};var addToCookies=function(key,value){if(typeof value=="undefined"){return false}if(!browserSupportsCookies()){$rootScope.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED");return false}try{var expiry="",expiryDate=new Date();if(value===null){cookie.expiry=-1;value=""}if(cookie.expiry!==0){expiryDate.setTime(expiryDate.getTime()+(cookie.expiry*24*60*60*1000));expiry=", expires="+expiryDate.toGMTString()}if(!!key){document.cookie=prefix+key+"="+encodeURIComponent(value)+expiry+", path="+cookie.path}}catch(e){$rootScope.$broadcast("LocalStorageModule.notification.error",e.message);return false}return true};var getFromCookies=function(key){if(!browserSupportsCookies()){$rootScope.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED");return false}var cookies=document.cookie.split(",");for(var i=0;i<cookies.length;i++){var thisCookie=cookies[i];while(thisCookie.charAt(0)==" "){thisCookie=thisCookie.substring(1,thisCookie.length)}if(thisCookie.indexOf(prefix+key+"=")===0){return decodeURIComponent(thisCookie.substring(prefix.length+key.length+1,thisCookie.length))}}return null};var removeFromCookies=function(key){addToCookies(key,null)};var clearAllFromCookies=function(){var thisCookie=null,thisKey=null;var prefixLength=prefix.length;var cookies=document.cookie.split(";");for(var i=0;i<cookies.length;i++){thisCookie=cookies[i];while(thisCookie.charAt(0)==" "){thisCookie=thisCookie.substring(1,thisCookie.length)}key=thisCookie.substring(prefixLength,thisCookie.indexOf("="));removeFromCookies(key)}};var stringifyJson=function(vContent,isJSON){if(typeof vContent==="string"&&vContent.charAt(0)!=="{"&&!isJSON){return vContent}if(vContent instanceof Object){var sOutput="";if(vContent.constructor===Array){for(var nId=0;nId<vContent.length;sOutput+=this.stringifyJson(vContent[nId],true)+",",nId++){}return"["+sOutput.substr(0,sOutput.length-1)+"]"}if(vContent.toString!==Object.prototype.toString){return'"'+vContent.toString().replace(/"/g,"\\$&")+'"'}for(var sProp in vContent){sOutput+='"'+sProp.replace(/"/g,"\\$&")+'":'+this.stringifyJson(vContent[sProp],true)+","}return"{"+sOutput.substr(0,sOutput.length-1)+"}"}return typeof vContent==="string"?'"'+vContent.replace(/"/g,"\\$&")+'"':String(vContent)};var parseJson=function(sJSON){if(sJSON.charAt(0)!=="{"){return sJSON}return eval("("+sJSON+")")};return{isSupported:browserSupportsLocalStorage,add:addToLocalStorage,get:getFromLocalStorage,remove:removeFromLocalStorage,clearAll:clearAllFromLocalStorage,stringifyJson:stringifyJson,parseJson:parseJson,cookie:{add:addToCookies,get:getFromCookies,remove:removeFromCookies,clearAll:clearAllFromCookies}}}]);app.factory("stationService",["$resource","$cacheFactory","$rootScope",function(d,f,b){var c=f("stationService");var a=d(b.iRailAPI+"/stations/?lang=en&format=json");return{getResource:function(h){var g=c.get("stations");if(!g){a.get(function(i){g=e(i.station);c.put("stations",g);h(g)})}else{h(g)}}};function e(k){var j=[];for(var g=0;g<k.length;g++){var h=k[g];j.push(h.name)}return j}}]);app.factory("utilityService",function(){return{addLeadingZeroIfNeeded:function(a){if(a<10){return"0"+a.toString()}return a.toString()},pngFallback:function(){if(!Modernizr.svg){(function(){var d=document.getElementsByTagName("img"),c=/.*\.svg$/,b=0,a=d.length;for(;b<a;++b){if(d[b].src.match(c)){d[b].src=d[b].src.slice(0,-3)+"png"}}})()}},getIrailDateString:function(b){var c=this.addLeadingZeroIfNeeded(b.getDate());var a=this.addLeadingZeroIfNeeded(b.getMonth()+1);var d=b.getFullYear().toString().substr(2);return c+a+d},getIrailTimeString:function(b){var a=this.addLeadingZeroIfNeeded(b.getHours());var c=this.addLeadingZeroIfNeeded(b.getMinutes());return a+c}}});app.factory("favoriteRouteService",["localStorageService","$rootScope",function(b,a){return{addFavorite:function(g,f){var c=JSON.parse(b.get("favoriteRoutes"));if(!c){c=[]}for(var e=0;e<c.length;e++){var d=c[e];if(d.from==g&&d.to==f){return}}c.push({from:g,to:f});b.add("favoriteRoutes",JSON.stringify(c))},removeFavorite:function(g,f){var c=JSON.parse(b.get("favoriteRoutes"));if(!c){return}for(var e=0;e<c.length;e++){var d=c[e];if(d.from==g&&d.to==f){c.splice(e,1);b.add("favoriteRoutes",JSON.stringify(c));return}}a.$broadcast("favoritesChanged")},getFavorites:function(){return JSON.parse(b.get("favoriteRoutes"))},exists:function(g,f){var c=JSON.parse(b.get("favoriteRoutes"));if(!c){return false}for(var e=0;e<c.length;e++){var d=c[e];if(d.from==g&&d.to==f){return true}}return false}}}]);app.factory("historyService",["localStorageService",function(a){return{add:function(b,h,g,f,c){var e=JSON.parse(a.get("history"));if(!e){e=[]}var d={datetime:b,location:{longitude:c,latitude:f},from:h,to:g};e.push(d);a.add("history",JSON.stringify(e))}}}]);